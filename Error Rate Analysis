###################################################
##此段代码用于错误率分析
###################################################
rm(list=ls())
##导入两个函数
library(ggplot2)
library(plyr)

##确定数据文件路径
pa0='D:/nanweizhidropbox/Dropbox/2Cannon/exp2_20150519_2Cannon_Eye_30subs/data/Two Cannon Eye_full/Data'
##确定导出图片，SPSS数据文件
pa='D:/nanweizhidropbox/Dropbox/2Cannon/exp2_20150519_2Cannon_Eye_30subs/data/Two Cannon Eye_full/Result/RT'

##读入数据
data.raw<-read.table(paste(pa0,'3_33_full.csv',sep='/'),header=TRUE,sep=",",na.string=NULL)
data.raw$ACC=sapply(data.raw$corrresp==data.raw$whichButton,sum)
## 抽取相关变量
myvars1=c('RECORDING_SESSION_LABEL','nredpellets','cannonangle',
          'cannonorib','cannonorir','targetori','targetdist','targetcolor',
          'ACC','RT')


myvars=c('Subject','nRedPellets','CannonAngle','CannonOriB','CannonOriR',
         'TargetOri','TargetDist','TargetColor','ACC','RT')
data.cat=data.raw[myvars1]
names(data.cat)=myvars
##对数据做一些预处理，删除不必要试次，修改标题，修改变量类型
##保留数据中是正式实验的试次
data.nopractice=data.cat
data.nopractice$Subject = factor(data.nopractice$Subject)
##由于31号被试眼睛有些斜视。因此删除
data.nopractice=subset(data.nopractice,Subject!="sub31")

## 将颜色比例蓝：红放在colorRatio变量中，并转为因???
data.nopractice$ColorRatio = paste(as.character(8 - data.nopractice$nRedPellets),
                            as.character(data.nopractice$nRedPellets), sep=" : ")
data.nopractice$ColorRatio <- factor(data.nopractice$ColorRatio)
data.nopractice$Angle = paste(as.character(data.nopractice$CannonAngle))
data.nopractice$Angle <- factor(data.nopractice$Angle)
##根据目标大炮的朝向，分离出朝上和朝下两种781为朝上，345为朝下，26为中性
a=(data.nopractice$TargetColor=="B")
data.nopractice$TargetCannon[a]<-data.nopractice$CannonOriB[a]
data.nopractice$TargetCannon[!a]<-data.nopractice$CannonOriR[!a]
b=(data.nopractice$TargetCannon==1 | data.nopractice$TargetCannon==8 | data.nopractice$TargetCannon==7)
data.nopractice$Simon[b]<-c("Up")
c=(data.nopractice$TargetCannon==3 | data.nopractice$TargetCannon==4 | data.nopractice$TargetCannon==5)
data.nopractice$Simon[c]<-c("Down")
data.nopractice$Simon[!(b|c)]<-c("neutral")
data.nopractice$Simon<- factor(data.nopractice$Simon)


##分离出冲突，颜色比例，目标颜色的数据

data.nopractice.AngColTar.Subject=ddply(data.nopractice,.(Subject,Angle,TargetColor,ColorRatio),
                                 summarize,ERR=(1-mean(ACC))*100)
data.nopractice.AngColTar=ddply(data.nopractice.AngColTar.Subject,.(Angle,TargetColor,ColorRatio),
                         summarize,ERR.SD=sd(ERR),ERR=mean(ERR))


data.nopractice.AngSim.Subject=ddply(data.nopractice,.(Subject,Angle,Simon),summarize,ERR=100*(1-mean(ACC)))
####删除对应的neutral条件,朝向为2和6的条件
data.nopractice.AngSim.Subject=subset(data.nopractice.AngSim.Subject,Simon !="neutral")
data.nopractice.AngSim=ddply(data.nopractice.AngSim.Subject,.(Angle,Simon),summarize,
                      ERR.SD=sd(ERR),ERR=mean(ERR))

##计算被试个数
nSubject=nlevels(data.nopractice$Subject)

data.nopractice.AngColTar$ERR.SE=data.nopractice.AngColTar$ERR.SD/sqrt(nSubject)
data.nopractice.AngSim$ERR.SE=data.nopractice.AngSim$ERR.SD/sqrt(nSubject)


##编写repeated-measure ANOVA的eta-squared函数
es=function(x,n=NULL) {
  if(is.null(n)) n=length(names(x))-2
  k=NULL
  p=summary(x)
  for(i in (1:n)+1) {
    l=unlist(p[i][[1]])
    k=c(k,l[3]/sum(l[3:4]))
  }
  names(k)=names(p)[(1:n)+1]
  k
}

sink(paste(pa,'bartlett angcoltar ERR.txt',sep='/'))
##方差齐性检验
bartlett.test(ERR~interaction(Angle,ColorRatio,
                             TargetColor),data=data.nopractice.AngColTar.Subject)
sink()
##目标颜色，大炮夹角和背景点颜色比例方差分析
AngColRat=aov(ERR ~ Angle*TargetColor*ColorRatio + Error(Subject/
                                                          (Angle*TargetColor*ColorRatio)), data=data.nopractice.AngColTar.Subject)
sink(paste(pa,'aov TargetColor_ColorRatio_Angle ERR.txt',sep='/'))
summary(AngColRat)
cat('\n\nEta-Squared\n')
es(AngColRat)
sink()



##方差齐性检验
sink(paste(pa,'bartlett angsim_ERR.txt',sep='/'))
bartlett.test(ERR~interaction(Angle,Simon),data=data.nopractice.AngSim.Subject)
sink()
##大炮朝向和夹角方差分析
Result=(aov(ERR ~ Angle*Simon+ Error(Subject/(Angle*Simon)),
            data=data.nopractice.AngSim.Subject))
sink(paste(pa,'aov Simon_Angle ERR.txt',sep='/'))
summary(Result)
cat('\n\nEta-Squared\n')
es(Result)
sink()


##输出平均值标准差
write.csv(data.nopractice.AngSim,paste(pa,'不同条件下的均值方差_Response Time_AngSim ERR.csv',sep='/'))
write.csv(data.nopractice.AngColTar,paste(pa,'不同条件下的均值方差_Response Time_AngColTar ERR.csv',sep='/'))



###SPSS
library(reshape)
data.SPSS.AngColTar=cast(data.nopractice.AngColTar.Subject,Subject~Angle~TargetColor~ColorRatio,value="ERR")
write.table(data.SPSS.AngColTar,paste(pa,'data_SPSS_AngColTar_ERR.csv',sep='/'),sep=',',col.names=NA,qmethod="double")
data.SPSS.AngSim=cast(data.nopractice.AngSim.Subject,Subject~Angle~Simon,value="ERR")
write.table(data.SPSS.AngSim,paste(pa,'data_SPSS_AngSim_ERR.csv',sep='/'),sep=',',col.names=NA,qmethod="double")

###SPSS_180,0
data.nopractice.AngColTar.Subject.180=subset(data.nopractice.AngColTar.Subject,Angle==180)
data.SPSS.AngColTar.180=cast(data.nopractice.AngColTar.Subject.180,Subject~TargetColor~ColorRatio,value="ERR")
write.table(data.SPSS.AngColTar.180,paste(pa,'data_SPSS_AngColTar_180_ERR.csv',sep='/'),sep=',',col.names=NA,qmethod="double")
data.nopractice.AngColTar.Subject.0=subset(data.nopractice.AngColTar.Subject,Angle==0)
data.SPSS.AngColTar.0=cast(data.nopractice.AngColTar.Subject.0,Subject~TargetColor~ColorRatio,value="ERR")
write.table(data.SPSS.AngColTar.180,paste(pa,'data_SPSS_AngColTar_0_ERR.csv',sep='/'),sep=',',col.names=NA,qmethod="double")




